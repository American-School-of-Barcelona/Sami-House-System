{% extends "base.html" %}

{% block title %}Add Students - House Points System{% endblock %}

{% block content %}
    <h2>Add New Students</h2>
    <p style="margin-bottom: 30px; color: #e8e8d0;">Choose a method to add students: manual entry or CSV upload.</p>

    <!-- Tab Navigation with query parameters -->
    {% set current_tab = request.args.get('tab', 'manual') %}
    <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #555;">
        <a href="{{ url_for('add_student', tab='manual') }}" style="padding: 15px 30px; background: {% if current_tab == 'manual' %}#e8e8d0{% else %}#555{% endif %}; color: {% if current_tab == 'manual' %}#2b2b2b{% else %}#fff{% endif %}; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block;">Manual Entry</a>
        <a href="{{ url_for('add_student', tab='csv') }}" style="padding: 15px 30px; background: {% if current_tab == 'csv' %}#e8e8d0{% else %}#555{% endif %}; color: {% if current_tab == 'csv' %}#2b2b2b{% else %}#fff{% endif %}; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block;">CSV Upload</a>
    </div>

    <!-- Manual Entry Tab -->
    {% if current_tab == 'manual' %}
    <div>
        <!-- House Suggestion Helper -->
        {% if suggestion %}
        {% set siblings_split = suggestion.reason.startswith('Siblings split') %}
        <div style="background: {% if siblings_split %}#5f5f4a{% else %}#4a5f4a{% endif %}; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid {% if siblings_split %}#ffeb3b{% else %}#90ee90{% endif %};">
            <h3 style="color: {% if siblings_split %}#ffeb3b{% else %}#90ee90{% endif %}; margin-bottom: 10px;">
                {% if siblings_split %}‚ö†Ô∏è{% else %}üí°{% endif %} House Suggestion
            </h3>
            <p style="color: #e8e8d0; margin-bottom: 10px;"><strong>Suggested House:</strong> {{ suggestion.house_name }}</p>
            <p style="color: #c8c8b0; font-size: 14px; margin-bottom: 10px;"><strong>Reason:</strong> {{ suggestion.reason }}</p>

            {% if siblings_split %}
            <div style="background: #4a4a3a; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #ffeb3b;">
                <p style="color: #ffeb3b; font-size: 13px; margin: 0;">
                    <strong>‚ö†Ô∏è Note:</strong> Siblings are in different houses. Review the list below and choose the appropriate house for this student.
                </p>
            </div>
            {% endif %}

            {% if suggestion.siblings %}
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #6a7a6a;">
                <p style="color: #e8e8d0; font-size: 14px; margin-bottom: 8px;"><strong>Found {{ suggestion.siblings|length }} sibling(s) with this last name:</strong></p>
                <ul style="color: #c8c8b0; font-size: 14px; margin-left: 20px;">
                    {% for fname, house_name, grade in suggestion.siblings %}
                    <li>{{ fname }} - {{ grade }} (<strong style="color: #e8e8d0;">{{ house_name }}</strong>)</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('add_student', tab='manual') }}">
            <input type="hidden" name="import_type" value="manual">
            <input type="hidden" name="student_count" value="1">

            <div style="background: #3a3a3a; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #e8e8d0; margin-bottom: 15px;">Student Information</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="fname_0">First Name:</label>
                        <input type="text" id="fname_0" name="fname_0" value="{{ request.args.get('suggest_fname', '') }}" required>
                    </div>

                    <div class="form-group">
                        <label for="lname_0">Last Name:</label>
                        <input type="text" id="lname_0" name="lname_0" value="{{ request.args.get('suggest_lname', '') }}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email_0">Email:</label>
                    <input type="email" id="email_0" name="email_0" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="house_id_0">House:</label>
                        <select id="house_id_0" name="house_id_0" required>
                            <option value="">-- Select a House --</option>
                            {% for house_id, house_name, color in houses %}
                            <option value="{{ house_id }}" {% if suggestion and suggestion.house_id == house_id %}selected{% endif %}>{{ house_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="class_year_id_0">Class Year:</label>
                        <select id="class_year_id_0" name="class_year_id_0" required>
                            <option value="">-- Select a Class Year --</option>
                            {% for class_year_id, class_name, grad_year in class_years %}
                            <option value="{{ class_year_id }}" {% if request.args.get('suggest_grade') and class_name.startswith(request.args.get('suggest_grade')) %}selected{% endif %}>{{ class_name }} ({{ grad_year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="submit">Save Student</button>
                <a href="{{ url_for('students') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>

        <!-- Get House Suggestion Form -->
        <div style="background: #3a3a3a; padding: 20px; border-radius: 10px; margin-top: 30px; border-top: 2px solid #555;">
            <h3 style="color: #e8e8d0; margin-bottom: 15px;">üîç Get House Suggestion</h3>
            <p style="color: #c8c8b0; margin-bottom: 15px; font-size: 14px;">Enter student details to get an automatic house suggestion based on siblings, grade, or balance.</p>

            <form method="GET" action="{{ url_for('add_student', tab='manual') }}">
                <input type="hidden" name="tab" value="manual">
                <input type="hidden" name="get_suggestion" value="1">

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="suggest_fname_input">First Name:</label>
                        <input type="text" id="suggest_fname_input" name="suggest_fname" placeholder="Optional" value="{{ request.args.get('suggest_fname', '') }}">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="suggest_lname_input">Last Name:</label>
                        <input type="text" id="suggest_lname_input" name="suggest_lname" required value="{{ request.args.get('suggest_lname', '') }}">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="suggest_grade_input">Grade:</label>
                        <select id="suggest_grade_input" name="suggest_grade" required>
                            <option value="">Select...</option>
                            <option value="9" {% if request.args.get('suggest_grade') == '9' %}selected{% endif %}>9th</option>
                            <option value="10" {% if request.args.get('suggest_grade') == '10' %}selected{% endif %}>10th</option>
                            <option value="11" {% if request.args.get('suggest_grade') == '11' %}selected{% endif %}>11th</option>
                            <option value="12" {% if request.args.get('suggest_grade') == '12' %}selected{% endif %}>12th</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="suggest_homeroom_input">Homeroom:</label>
                        <select id="suggest_homeroom_input" name="suggest_homeroom">
                            <option value="">N/A</option>
                            <option value="9A" {% if request.args.get('suggest_homeroom') == '9A' %}selected{% endif %}>9A (Artemis)</option>
                            <option value="9B" {% if request.args.get('suggest_homeroom') == '9B' %}selected{% endif %}>9B (Athena)</option>
                            <option value="9C" {% if request.args.get('suggest_homeroom') == '9C' %}selected{% endif %}>9C (Poseidon)</option>
                            <option value="9D" {% if request.args.get('suggest_homeroom') == '9D' %}selected{% endif %}>9D (Apollo)</option>
                        </select>
                    </div>

                    <button type="submit" style="margin-bottom: 0;">Get Suggestion</button>
                </div>

                <p style="color: #c8c8b0; margin-top: 10px; font-size: 13px; font-style: italic;">
                    Note: For 9th graders, homeroom is required (9A=Artemis, 9B=Athena, 9C=Poseidon, 9D=Apollo)
                </p>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- CSV Upload Tab -->
    {% if current_tab == 'csv' %}
    <div>
        <div style="background: #3a3a3a; padding: 30px; border-radius: 15px;">
            <p style="margin-bottom: 20px; color: #fff;">Upload a CSV file with student information. Perfect for importing entire grade levels.</p>

            <div style="background: #d4edda; padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #28a745; color: #155724;">
                <strong>CSV Format Required:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><code>first_name</code>, <code>last_name</code>, <code>email</code>, <code>house</code>, <code>class_year</code></li>
                </ul>
                <p style="margin-top: 10px; margin-bottom: 0;"><strong>Example:</strong></p>
                <pre style="background: #fff; color: #333; padding: 10px; border-radius: 5px; margin-top: 5px; overflow-x: auto;">first_name,last_name,email,house,class_year
John,Smith,john.smith@asbarcelona.com,Athena,Freshman</pre>
            </div>

            <form method="POST" action="{{ url_for('add_student', tab='csv') }}" enctype="multipart/form-data">
                <input type="hidden" name="import_type" value="csv">

                <div class="form-group">
                    <label for="csv_file">Select CSV File:</label>
                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required style="background: #2b2b2b; border: 2px solid #555; color: #fff; padding: 10px; border-radius: 8px; width: 100%;">
                </div>

                <button type="submit" style="background: #28a745; color: #fff; padding: 12px 30px; font-size: 1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer;">
                    Upload and Import CSV
                </button>
            </form>
        </div>
    </div>
    {% endif %}
{% endblock %}
